#!/bin/bash
export __VIM_PROG__=/tmp/__VIM_PROG__$$
export __VIM_ARG__=/tmp/__VIM_ARG__$$
export __LF_DIR__=/tmp/__LF_DIR__$$

export __VIMCD__=1
export __LFCD__=2
export __FZF__=3
export __FZFLIVE__=4
export __FZFEXACT__=5
export __FZFEXACTLIVE__=6
export __FZFLIVEEXACT__=6
export __FZFLIVEHOME__=7
export __FZFHOMELIVE__=7
export __GREPVIM__=8

__vim_sel__()
{
	[ ! -f $__VIM_PROG__ ] 2>/dev/null && return
	local prog=$(<$__VIM_PROG__)
	if [ ! -f $__VIM_ARG__ ] 2>/dev/null; then
		local arg=''
	else
		local arg=$(<$__VIM_ARG__)
	fi
	(/bin/rm -f $__VIM_PROG__ &)
	(/bin/rm -f $__VIM_ARG__ &)
	case $prog in
	$__VIMCD__) vimcd $arg ;;
	$__LFCD__) lfcd $arg ;;
	$__FZF__) fzfvim $arg ;;
	$__FZFLIVE__) fzflive $arg ;;
	$__FZFEXACT__) fzfexact $arg ;;
	$__FZFEXACTLIVE__) fzfexactlive $arg ;;
	$__FZFLIVEHOME__) cd $HOME && fzflive $arg ;;
	$__GREPVIM__) grepvim ;;
	esac
}

lfcd()
{
	touch $__LF_DIR__
	lf -last-dir-path="$__LF_DIR__" "$@" &&
		__vim_sel__
	local dir=$(<$__LF_DIR__)
	([ -f $__LF_DIR__ ] && /bin/rm -f $__LF_DIR__ 2>/dev/null >/dev/null &)
	[ -d "$dir" ] && [ "$dir" != "$(pwd)" ] && cd "$dir"
}

fzfbase()
{
	local file=$(${@##* })
	if [ ! $file ]; then
		return
	elif [ -f "$file" ]; then
		vimcd $file
	else
		lfcd $file
	fi
}

fzfvim()
{
	fzfbase fzfdef $@
}

fzfexact()
{
	cd $HOME
	fzfbase fzfdef -e
}

fzflive()
{
	fzfbase fzfpreview
}

fzfexactlive()
{
	cd $HOME
	fzfbase fzfpreview -e
}

grepvim()
{
	local out=$(rg -j $__NPROC__ --line-number --no-heading --color=always --smart-case '' | fzf -d ':' -n 2.. --ansi --preview-window 'down:20%:+{2}' --preview 'bat --style=numbers --color=always --highlight-line {2} {1}')
	[ $out ] || return
	vimcd -c ":$(echo $out | cut -d':' -f2)" ${out%%:*}
}

vimcd()
{
	local cmd
	local file
	case $1 in
	'')
		cmd=$EDITOR
		file=
		;;
	'-c')
		file=$(realpath $3)
		[ -f $file ] || return
		cd ${file%/?*}
		cmd=$EDITOR
		set -- -c $2
		;;
	*)
		file=$(realpath ${@##* })
		if [ -f $file ]; then
			cd ${file%/?*}
			cmd=$EDITOR
		elif [ -d $file ]; then
			cd $file
			cmd=lfcd
		else
			cd $(dirname $file)
			touch $file
			cmd=$EDITOR
		fi
		shift
		;;
	esac
	$cmd $file $@ &&
		__vim_sel__
}

mkdir()
{
	local file=$(realpath ${@##* } 2>/dev/null)
	[ -d $file ] || (fzf_update_dir $file &)
	/bin/mkdir $@
}

touch()
{
	local file=$(realpath ${@##* } 2>/dev/null)
	[ -f $file ] || (fzf_update_dir $file &)
	/bin/touch $@
}
