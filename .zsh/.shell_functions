#!/bin/sh
export __VIM_PROG__="__VIM_PROG__$$"
export __VIM_ARG__="__VIM_ARG__$$"
export __LF_DIR__="__LF_DIR__$$"

lfcd()
{
	lf -last-dir-path="$__LF_DIR__" "$@" &&
		__vim_sel__
	local dir=$(<$__LF_DIR__)
	(/bin/rm -f $__LF_DIR__ &)
	[ -d "$dir" ] && [ "$dir" != "$(pwd)" ] && cd "$dir"
}

fzfbase()
{
	file=$(${@##* })
	[ ! $file ] && return
	if [ -f "$file" ]; then
		vimcd $file
	else
		lfcd $file
	fi
}

fzfvim()
{
	fzfbase fzfdef $@
}
fzfexact()
{
	cd $HOME
	fzfbase fzfdef -e
}
fzflive()
{
	fzfbase fzfpreview
}
fzfexactlive()
{
	cd $HOME
	fzfbase fzfpreview -e
}

vimcd()
{
	local cmd
	local file
	case $1 in
	'')
		cmd=$EDITOR
		file=
		;;
	*)
		file=$(realpath ${@##* })
		if [ -f $file ]; then
			cd ${file%/?*}
			cmd=$EDITOR
		elif [ -d $file ]; then
			cd $file
			cmd=lfcd
		else
			cd $(dirname $file)
			touch $file
			cmd=$EDITOR
		fi
		shift
		;;
	esac
	$cmd $file $@ &&
		__vim_sel__
}

export __VIMCD__=1
export __LFCD__=2
export __FZF__=3
export __FZFLIVE__=4
export __FZFEXACT__=5
export __FZFEXACTLIVE__=6
export __FZFLIVEEXACT__=6
export __FZFLIVEHOME__=7
export __FZFHOMELIVE__=7

__vim_sel__()
{
	[ ! -f $__VIM_PROG__ ] 2>/dev/null && return
	local prog=$(<$__VIM_PROG__)
	if [ ! -f $__VIM_ARG__ ] 2>/dev/null; then
		local arg=''
	else
		local arg=$(<$__VIM_ARG__)
	fi
	(/bin/rm -f $__VIM_PROG__ &)
	(/bin/rm -f $__VIM_ARG__ &)
	case $prog in
	$__VIMCD__) vimcd $arg ;;
	$__LFCD__) lfcd $arg ;;
	$__FZF__) fzfvim $arg ;;
	$__FZFLIVE__) fzflive $arg ;;
	$__FZFEXACT__) fzfexact $arg ;;
	$__FZFEXACTLIVE__) fzfexactlive $arg ;;
	$__FZFLIVEHOME__) cd $HOME && fzflive $arg ;;
	esac
}

mkdir()
{
	local file=$(realpath ${@##* } 2>/dev/null)
	[ -d $file ] || (fzf_update_dir $file &)
	/bin/mkdir $@
}

touch()
{
	local file=$(realpath ${@##* } 2>/dev/null)
	[ -f $file ] || (fzf_update_dir $file &)
	/bin/touch $@
}
