#!/bin/sh
file=$1
cd "$(dirname "$file")" || exit 1
flags='-Wall -Wextra -Warray-bounds -Wshadow -Wuninitialized -Wunused-variable -Wnull-dereference -Wformat'
analyzer='-fanalyzer -fsanitize=address -g'
shift
vg=
vg_flag=
CC=cc
CPP='c++'
for opt in "$@"; do
	case $opt in
	*.h) exit 1 ;;
	0 | 1 | 2 | 3)
		OLevel="-O$opt"
		flags="$flags -flto -march=native"
		;;
	s | S) flags="$flags $analyzer -g" ;;
	d | D | g | G) flags="$flags -g" ;;
	v)
		flags="$flags -g"
		vg=valgrind
		vg_flag='--leak-check=full --show-leak-kinds=all --track-origins=yes --verbose'
		;;
	t) CC=tcc ;;
	*) flags="$flags $opt" ;;
	esac
done
case $file in
*.c | *.cpp | *.cc) ;;
*)
	case $(find . -type f -name '*.c' -o -name '*.cpp' -o -name '*.cc') in
	*$file.cpp*) file=$file.cpp ;;
	*$file.cc*) file=$file.cc ;;
	*$file.c*) file=$file.c ;;
	*)
		echo 'Not a .c or .cpp file!'
		exit 1
		;;
	esac
	;;
esac
flags="$OLevel $file -o $(basename "$file" ".${file#*.}") $flags"
case $file in
*.c) compiler=$CC ;;
*.cpp | *.cc)
	compiler=$CPP
	;;
esac
echo "$compiler $flags"
echo
#shellcheck disable=SC2086
$compiler $flags || exit 1
#shellcheck disable=SC2086
$vg ./${file%.*} $vg_flag
