#!/bin/sh
file=$1
cd "$(dirname "$file")" || return
flags='-Wall -Wextra -Warray-bounds -Wshadow -Wuninitialized -Wunused-variable -Wnull-dereference -Wformat'
analyzer='-fanalyzer'
shift
for opt in "$@"; do
	case $opt in
	0 | 1 | 2 | 3) OLevel="-O$opt -flto" ;;
	s | S) flags="$flags $analyzer" ;;
	*) flags="$flags $opt" ;;
	esac
done
case $file in
*.c | *.cpp) ;;
*) case $(echo *.c *.cpp) in
	*$file.cpp*) file=$file.cpp ;;
	*$file.c*) file=$file.c ;;
	*)
		echo 'Not a .c or .cpp file!'
		return
		;;
	esac ;;
esac
# get impl.c from
# include "header.h" /* impl.c */
get_incl()
{
	sed -n "s/[ \t ]*#[ \t]*include[ \t]\{1,\}\"\([^ \t]*\)\{1,\}\"[ \t]\{1,\}.*\([-\/_.0-9A-Za-z]\{1,\}$1\).*/\1/p" "$2"
}
o=$(get_incl .o "$file")
c=$(get_incl .c "$file")
cpp=$(get_incl .cpp "$file")
precomp=$(get_incl .gch "$file")
flags="$OLevel $flags $file $c $precomp $o -o $(basename "$file" ".${file#*.}")"
case $file in
*.c) compiler=gcc ;;
*.cpp)
	compiler=g++
	flags="$flags $cpp -std=gnu++17"
	;;
esac
echo "$compiler" "$flags"
$compiler $flags || return
