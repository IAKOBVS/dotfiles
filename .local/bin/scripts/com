#!/bin/sh
file=$1
cpp_ver='-std=gnu++17'
comp_flags='-Wall -Wextra -Warray-bounds -Wshadow -Wuninitialized -Wunused-variable -Wnull-dereference -Wformat'
analyzer='-fanalyzer'
case $3 in
	0|1|2|3)
		OLevel="-O$3 -flto"
		comp_flags="$comp_flags $analyzer";;
	*)
		case $2 in
			0|1|2|3) OLevel="-O$2 -flto";;
			s|S) comp_flags="$comp_flags $analyzer";;
			*) comp_flags=''
		esac
esac
dirfiles=$(find . -type f -name '*.c' -o -name '*.cpp' 2> /dev/null)
case $file in
	*.c) ext=c;;
	*.cpp) ext=cpp;;
	*)
		case $dirfiles in
			*$file.cpp*) ext=cpp;;
			*$file.c*) ext=c;;
			*)
				echo 'not a .c or .cpp file!'
				return
		esac
		file=$file.$ext
esac
get_incl(){ sed -n "s/#[[:space:]]*include[[:space:]]*\"\([^[:space:]]*\).*\".*$1/\1$1/p" "$2";}
incl_c=$(get_incl .c "$file")
incl_cpp=$(get_incl .cpp "$file")
incl_precomp=$(get_incl .gch "$file")
flags="$comp_flags $file $incl_c $incl_precomp -o $(basename $file .$ext) $OLevel"
if test $ext = c
then
	compiler=gcc
else
	compiler=g++
	flags="$flags $incl_cpp $cpp_ver"
fi
echo $compiler $flags
$compiler $flags || return
