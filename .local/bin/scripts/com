#!/bin/sh
file=$1
cpp_ver='-std=gnu++17'
comp_flags='-Wall -Wextra -Warray-bounds -Wshadow -Wuninitialized -Wunused-variable -Wnull-dereference -Wformat'
analyzer='-fanalyzer'
shift
for opt in $@
do
	case $opt in
		0|1|2|3)
			OLevel="-O$opt -flto";;
		s|S)
			comp_flags="$comp_flags $analyzer"
	esac
done
dirfiles=$(find . -type f -name '*.c' -o -name '*.cpp' 2> /dev/null)
case $file in
	*.c|*.cpp);;
	*)
		case $dirfiles in
			*$file.cpp*) file=$file.cpp;;
			*$file.c*) file=$file.c;;
			*)
				echo 'Not a .c or .cpp file!'
				return
		esac
esac
get_incl(){ sed -n "s/#[[:space:]]*include[[:space:]]*\"\([^[:space:]]*\).*\".*$1/\1$1/p" "$2";}
incl_c=$(get_incl .c "$file")
incl_cpp=$(get_incl .cpp "$file")
incl_precomp=$(get_incl .gch "$file")
flags="$OLevel $comp_flags $file $incl_c $incl_precomp -o $(basename $file .$ext)"
case $file in
	*.c)
		compiler=gcc;;
	*.cpp)
		compiler=g++
		flags="$flags $incl_cpp $cpp_ver"
esac
echo $compiler $flags
$compiler $flags || rkturn
