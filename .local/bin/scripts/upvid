#!/bin/sh
set -euxo
# high-end
# shaders=~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/Anime4K_Restore_CNN_VL.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_VL.glsl:~~/shaders/Anime4K_Restore_CNN_M.glsl:~~/shaders/Anime4K_AutoDownscalePre_x2.glsl:~~/shaders/Anime4K_AutoDownscalePre_x4.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_M.glsl
# low-end
shaders=~~/shaders/Anime4K_Clamp_Highlights.glsl:~~/shaders/Anime4K_Restore_CNN_M.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_M.glsl:~~/shaders/Anime4K_Restore_CNN_S.glsl:~~/shaders/Anime4K_AutoDownscalePre_x2.glsl:~~/shaders/Anime4K_AutoDownscalePre_x4.glsl:~~/shaders/Anime4K_Upscale_CNN_x2_S.glsl
newdir=upscaled
mkdir -p $newdir
for file in "$@"; do
	ext=${file##*.}
	file_wo_ext=${file##*/}
	file_wo_ext=${file_wo_ext%.*}
	upscaled="$file_wo_ext"_upscaled."$ext"
	mpv "$file" --no-sub --glsl-shaders="$shaders" -vf=gpu="w=1920:h=1080" --o="$upscaled" || exit
	i=0
	while [ "$i" -ne "$(subtracks "$file")" ]; do
		srt="$file_wo_ext"_upscaled_"$i".srt
		ffmpeg -i "$file" -map "0:s:$i" "$srt"
		test "$subs" && subs=' '
		subs="$subs$srt"
		i=$((i + 1))
	done
	addsub "$upscaled" $subs
	cd $newdir
	mkdir -p subs
	mv -- *.srt subs
	mkdir -p baks
	mv -- *.bak baks
	# rm "$upscaled.bak"
done
