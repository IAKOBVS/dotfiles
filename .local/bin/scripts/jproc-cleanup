#!/bin/sh

set -u

CMD='jproc-cleanup'

# # Do not execute if already running
[ $(ps -e -o comm | grep -cF "$CMD") -gt 2 ] && exit

# C implementation uses procfs
if [ $(uname) = 'Linux' ]; then
	jproc-cleanup-bin
else
	# Portable POSIX version
	if [ ! "$JPROC_DIR" ] || [ -z "$JPROC_DIR" ] || ! [ -d "$JPROC_DIR" ] || ! cd "$JPROC_DIR"; then
		echo "$CMD:$JPROC_DIR dir not found."
		exit 1
	fi
	# open $JPROC_DIR/[pid]
	for pid in $(echo [0-9]*); do
		# remove if inactive pid
		if [ -d $pid ] && kill -0 "$pid" >/dev/null 2>/dev/null; then
			rm $pid/[0-9A-Za-z]*
			rmdir "$pid"
		fi
	done
fi
