#!/bin/sh
usage='usage: ./waifu2xauto <image> <scale>'
case $1 in
*.png | *.jpg | *.jpeg | *.webp) ;;
*)
	echo $usage
	echo 'Not an image file!'
	return 1
	;;
esac
scale=$2

#waifu2x is blurry
if [ $scale -le 3 ]; then
	scale=4
fi

denoise=$3
if [ -z $denoise ]; then
	out=${1%.*}-hd-$scale'x.png'
	denoise=1
else
	out=${1%.*}-hd-$scale'x'-n$denoise'.png'
fi
if [ $scale -le 3 ]; then
	waifu2x-ncnn-vulkan -i "$1" -o "$out" -s 2 -n "$denoise" -v
	exit
elif [ $2 -le 4 ]; then
	n=0
elif [ $2 -le 16 ]; then
	n=1
elif [ $2 -le 32 ]; then
	n=2
elif [ $2 -le 64 ]; then
	n=3
else
	echo $usage
	echo 'Illegal number used! Use 1, 2, 3, 4, 16, 32, or 64 instead.'
	return 1
fi
scale=4
upscaler=realesrgan-x4plus
realesr()
{
	realesrgan-ncnn-vulkan -i "$1" -o "$out" -s "$scale" -n "$upscaler" -v
}
realesr $1
i=0
while [ $i -lt $n ]; do
	realesr "$out"
	i=$((i = i + 1))
done
resolution=$(identify -ping "$out" | awk '{print $3}' | sed 's/x.*//')
if [ $resolution -gt 2400 ]; then
	res "$out" 2400
	rm "$out"
fi
