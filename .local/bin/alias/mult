#!/usr/bin/bash
echo '1' | "${@:2}" || exit

set -e

# Validate input
if [ "$#" -lt 1 ]; then
	echo "Usage: $0 <input_file> [num_of_cores]"
	exit 1
fi

# Get input file information
file_full="$(realpath "$1")"
file="$(basename "$file_full")"
file_path="$(dirname "$file_full")"
file_size="$(stat -c%s "$file_full")"

# Determine number of cores to use
num_of_cores="$(nproc)"

# Determine output directory
ram="$(free | awk '/Mem/ {print $2}')"
if [ "$ram" -lt "$((file_size * 2))" ]; then
	file_out_dir="$file_path"
else
	file_out_dir="/tmp"
fi

# Split input file
split -d -n "$num_of_cores" "$file_full" "$file_out_dir/$file"

# Process split files in parallel
for split_file in "$file_out_dir/$file"0*; do
	"${@:2}" > "$split_file" &
done
wait

# Concatenate processed split files
cat "$file_out_dir/$file"0* > "${file_full}.out"

# Clean up split files
rm "$file_out_dir/$file"0*
